# Virtual Private Cloud

## vpc란 무엇인가?
**Amazon Virtual Private Cloud(Amazon VPC)**를 사용하면 정의한 논리적으로 격리된 **가상 네트워크**에서 AWS 리소스를 시작할 수 있습니다. 이 가상 네트워크는 AWS의 확장 가능한 인프라를 사용한다는 이점과 함께 고객의 자체 데이터 센터에서 운영하는 기존 네트워크와 매우 유사합니다.

## VPC 특징

- 논리적으로 독립된 가상의 네트워크이다.
- 원하는 사설망 구축 가능하다.
- 부여된 IP 대역을 분할하여 사용 가능
- 리전 단위이다.

예전 AWS는 다른 사용자와 함께 사용하는 EC2-classic 버전이었지만, 현재 AWS는 기본적으로 VPC를 생성해준다. 따라서 특별한 상황이 아니라면 번거롭게 직접 네트워크 환경을 구축하지 않아도 된다.

# 기본 VPC 구성 요소
- 인터넷 게이트웨이
- ACL / 보안 그룹
- 라우트 테이블
- NAT instance / NAT Gateway
- Bastion Host
- VPC EndPoint
- - IPv4 CIDR 크기가 16인 블록을 필수적으로 가진다(172.31.0.0/16) → 2^(32-16) = 65536개의 IP사용가능
- 각 가용 영역 크기 /20의 개본 서브넷 생성한다. → 2^(32-20) = 4096개의 IP사용가능
- 인터넷 게이트웨이를 만들어 VPC에 연결한다.
- 기본 라우팅 테이블에 모든 트래픽(0.0.0.0/0)이 인터넷 게이트 웨이로 전달되는 경로를 추가한다.
- 기본 보안 그룹을 만들어 기본 VPC에 연결한다.
- 네트워크 ACL을 생성해 기본 VPC에 연결한다.
- AWS 계절에서 설정된 기본 DHCP 옵션을 기본 VPC에 연결한다.

<aside>
💡 가용영역?
AWS 리전에 중복 전원, 네트워킹 및 연결이 있는 하나 이상의 개별 데이터 센터. 여러 AZ를 사용해서 단일 데이터 센터에서 가능한 것보다 더 높은 가용성, 내결함성 및 확장성을 갖춘 프로덕션 애플리케이션 및 데이터베이스를 운용할 수 있다. (보통 2개 사용함)

</aside>

## IPv4 VPC CIDR 블록

<aside>
💡 CIDR란?
**CIDR**(Classless Inter-Domain Routing, 사이더)는 클래스 없는 도메인 간 라우팅 기법으로 1993년 도입되기 시작한, 최신의 IP 주소 할당 방법이다. CIDR는 기존의 IP 주소 할당 방식이었던 네트워크 클래스를 대체하였다. CIDR는 IP 주소의 영역을 여러 네트워크 영역으로 나눌 때 기존방식에 비해 유연성을 더해준다.

</aside>

클라우드의 자원들은 기본적으로 특정 네트워크 위에서 생성되며, 이를 접근하기 위해 **프라이빗 IP** 을 가진다. 즉, VPC의 CIDR범위 안에 적절한 IP를 가진다.

예를 들어 192.168.0.0/24 CIDR블록에서 생성된 EC2 인스턴스는 192.168.0.127을 받는다. 여기서 할당 가능한 IP가 소진되면 리소스 만들 수 없어서 적절한 크기의 VPC를 만들어야 한다. 하나의 VPC 최대 크기는 16이며, 인터넷 연결이 필요한 경우 반드시 **사설망 대역**을 사용해야 한다. 기본 규칙이 VPC의 CIDR블럭에 점유되기 때문에 같은 주소를 가진 (인터넷 접속이 가능한) 타IP 주소 접근하는 게 어렵다. ~~그리고 사설망의 블럭을 사용해도 다른 VPC와 통신할 때 CIDR이 겹치는 부분과 통신할 수 없다.~~

<aside>
💡 [사설망 IP주소]
10.0.0.0 ~ 10.255.255.255(10/8 prefix)
172.16.0.0 ~ 172.31.255.255(182.16/12 prefix)
192.168.0.0 ~ 192.168.255.255(192.168/16 prefix)

</aside>

- VPC를 만들 때는 VPC의 IPv4 CIDR블록을 지정해야 한다.
- 최대 크기는 /16 ~ /28
- CIDR 블록은 모든 VPC 라우팅 테이블에서 경로의 대상 CIDR 범위보다 작아야 한다.
- VPC에 연결한 CIDR 블록은 연결 해제가 가능하지만, 원래 VPC(기본 CIDR 블록)를 생성한 CIDR 블록은 연결을 해제할 수 없다.  → 그냥 한 번 생성하면 못 바꾼다는 뜻
- 기본 CIDR블록을 보려면 VPC콘솔창에서 다음 명령어 실행 후 확인

```nasm
aws ec2 describe-vpcs --vpc-id vpc-1a2b3c4d --query Vpcs[*].CidrBlock --output text
```

- 각 VPC는 하나의 리전에 종속된다.
- VPC간의 통신을 위해 VPC 피어링 서비스를 사용한다
- 일부 AWS는 172.17.0.0/16을 쓰기 때문에 충돌 방지를 위해 VPC 생성 시 이 범위는 사용하지 않는 게 좋음.
- 아이피 범위를 RFC1918이라는 사설 아이피 대역에 맞추어 구축해야 한다.
- 독립된 네트워크이기 때문에 CIDR가 같거나 겹쳐도 생성이 가능. 하지만 다수의 VPC를 함께 사용 시 IP대역이 겹치면 문제 발생 가능. → 왜????
- 보조 IPv4 CIDR 블록을 연결할 수도 있다. (주 CIDR블록이랑 대역 겹치면 안됨)

---

## 서브넷 (Subnet)

- VPC의 IP주소 범위. (서브넷 최대 크기 = VPC 크기)
    - /28 넷마스크 ~ /16 넷마스크
    - 각 서브넷 CIDR 블록에서 첫 4개의 IP 주소와 마지막 IP 주소는 사용자가 사용할 수 없다.
    
    <aside>
    ⚠️ 예 : 10.0.0.0/24라면
    
    - 10.0.0.0: 네트워크 주소.
    - 10.0.0.1: AWS에서 VPC 라우터용으로 예약한 주소.
    - 10.0.0.2: AWS에서 예약한 주소. DNS 서버의 IP 주소는 기본 VPC 네트워크 범위에 2를 더한 주소입니다. CIDR 블록이 여러 개인 VPC의 경우, DNS 서버의 IP 주소가 기본 CIDR에 위치합니다. 또한 각 서브넷 범위의 기본에 2를 더한 주소를 VPC의 모든 CIDR 블록에 대해 예약합니다.
    - 10.0.0.3: AWS에서 앞으로 사용하려고 예약한 주소.
    - 10.0.0.255: 네트워크 브로드캐스트 주소. 근데 VPC에서는 브로드캐스트는 지원 안 함.
    </aside>
    
- EC2 인스턴스와 같은 AWS리소스를 서브넷에서 실행 가능.
- 각 서브넷은 단일 가용 영역 내부에서만 존재한다. (**하나의 서브넷은 하나의 가용존과 연결됨**.)
- VPC가 논리적 범위라면 서브넷은 실제 리소스가 생성될 수 있는 네트워크이므로 VPC만 지정되진 않는다.
- 리전에 따라 사용 가능한 가용존의 개수는 다름. (특정 리전에 사용할 수 있는 개수 미리 확인 필요!)
- 모든 가용존을 사용하지 않더라도 2개 이상 사용하는 게 일반적,
- 퍼블릭 서브넷을 통해 인터넷 게이트웨이로 직접 연결 가능하다.
- 모든 서브넷은 해당 서브넷에서 생성된 네트워크 인터페이스에 퍼블릭 IP가 할당될 것인지 여부를 결정하는 속성을 가짐. (해당 서브넷에서 인스턴스를 시작할 때 인스턴스에 대해 생성된 주 네트워크 인터페이스(eth0)가 포함)
- 서브넷 속성에 상관없이 특정 인스턴스를 시작하는 중에 해당 인스턴스에 대한 속성 수정 가능.
    - **`P 설정 자동 할당`**: 이 서브넷의 새 네트워크 인터페이스에 대한 퍼블릭 IPv4 또는 IPv6 주소를 자동으로 요청하도록 자동 할당 IP 설정을 구성할 수 있음.
    - **`리소스 기반 이름(RBN) 설정`**: 이 서브넷에서 EC2 인스턴스에 대한 호스트 이름 유형을 지정하고 DNS A 및 AAAA 레코드 쿼리가 처리되는 방법을 구성.

### 서브넷 유형

- **`퍼블릭 서브넷`** - 서브넷에 인터넷 게이트웨이(IGW)로 직접 연결되는 경로가 있다. 퍼블릭 서브넷의 리소스는 퍼블릭 인터넷에 액세스할 수 있다(퍼블릭 IP 부여 가능). 웹 서버, 어플리케이션 서버 등 유저에게 노출되어야 하는 인프라 등에 할당된다.
- **`프라이빗 서브넷`** - 서브넷에 인터넷 게이트웨이로 직접 연결되는 경로가 없다. 프라이빗 서브넷의 리소스에는 퍼블릭 인터넷에 액세스하기 위해 NAT 디바이스가 필요. 외부 노출이 필요 없는 DB, 로직 서버 인프라.
- **`VPN 전용 서브넷`** - 서브넷에 가상 프라이빗 게이트웨이를 통해 Site-to-Site VPN 연결으로 연결되는 경로가 있다. 서브넷에는 인터넷 게이트웨이에 대한 경로가 없다.
- **`격리된 서브넷`** - 서브넷에 VPC 외부 대상에 대한 경로가 없다 격리된 서브넷의 리소스는 동일한 VPC의 다른 리소스와만 서로 액세스할 수 있습니다.

A는 인터넷 게이트웨이에 연결된 퍼블릭 서브넷이고, B는 가상 프라이버시 게이트웨이로 연결된 VPN 전용 서브넷이다.

---

## 라우팅테이블

- 라우팅은 라우터(목적지)에 대한 이정표
- 서브넷과 연결되어 있는 리소스(VPC의 각 서브넷을 라우팅 테이블에 연결해야 함.)
- 특정 라우팅 테이블과 연결되지 않으면 그렇지않으면 서브넷이 기본 라우팅 테이블과 암시적으로 연결됨.
- 서브넷은 한 번에 하나의 라우팅 테이블에만 연결할 수 있지만 여러 서브넷을 동일한 서브넷 라우팅 테이블에 연결할 수 있음.
- 동일한 CIDR 블록 세트를 자주 참조하는 경우, [고객 관리형 접두사 목록](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/managed-prefix-lists.html)을 생성하여 함께 그룹화할 수 있음.
- 모든 라우팅 테이블에는 VPC 내부 통신을 위한 로컬 라우팅이 포함

## 규칙

- 라우팅 테이블에 라우팅이 여러 개 있는 경우 트래픽과 일치하는 가장 구체적인 라우팅(가장 긴 접두사 일치)을 사용하여 트래픽의 라우팅 방법을 결정.
- 로컬 경로보다 더 구체적인 경로를 라우팅 테이블에 추가할 수 있음.
- 정확히 일치하거나 169.254.168.0/22 범위의 하위 세트인 IPv4 주소에는 경로를 추가할 수 없음.(이미 예약되어 있음)

| 대상 주소 | 대상 |  |
| --- | --- | --- |
| 10.0.0.0/16 | Local | IPv4 트래픽 Local 경로 |
| 172.31.0.0/16 | pcx-11223344556677889 | 피어링 연결 |
| 0.0.0.0/0 | igw-12345678901234567 | 인터넷 게이트웨이 |

구체적인 IP : local > 피어링 > 인터넷 게이트웨이

### 기본 생성 라우팅 테이블

VPC를 만들면 기본 라우팅 테이블이 자동으로 생성된다. 서브넷이 라우팅 테이블과 명시적으로 연결되지 않은 경우 서브넷은 기본 라우팅 테이블이 기본적으로 사용된다.

- 기본 생성 라우팅 테이블은 해당 VPC안에 네트워크 범위를 가지는 로컬에서 찾음.(삭제 불가) ( CIDR 블럭을 목적지로 하는 경우)
- 외부로 통하는 트래픽은 인터넷 게이트를 사용 → 라우트 규칙을 추가 정의해야 함.
- 기본 라우팅 테이블은 삭제할 수 없음.
- 게이트웨이 라우팅 테이블은 기본 라우팅 테이블로 설정할 수 없음.
- 기본 라우팅 테이블은 인터넷으로 대상 주소가 정해진 서브넷 트래픽을 인터넷 게이트웨이로 전송하기 때문에 기본적으로 `퍼블릭 서브넷` 이다.

---

# 외부 연결
## 인터넷 게이트웨이(IGA)
- 0.0.0.0/0으로 연결되는 IGA는 인터넷과 연결되어 있고 이를 퍼블릭 서브넷.
- VPC에서 생성된 리소스들은 기본적으로 인터넷 사용이 불가능함.
- 인스턴스가 인터넷과 통신하려면 퍼블릭 주소가 필요
- 프라이빗 서브넷은 퍼블릭IP가 있다고 하더라도 통신 불가.
- NAT gateway로 퍼블릭IP 없어도 통신할 수 있음.

| 대상 주소 | 대상 |
| --- | --- |
| 172.31.0.0/16 | 로컬 |
| 0.0.0.0/0 | internet_gateway_id |

## NAT 게이트 웨이

<aside>
💡 NAT 게이트웨이는 NAT(네트워크 주소 변환) 서비스입니다. 프라이빗 서브넷의 인스턴스가 VPC 외부의 서비스에 연결할 수 있지만 외부 서비스에서 이러한 인스턴스와의 연결을 시작할 수 없도록 NAT 게이트웨이를 사용할 수 있습니다.

</aside>

### NAT 게이트웨이 유형

1. 퍼블릭
    - 프라이빗 서브넷의 인스턴스는 퍼블릭 NAT 게이트웨이를 통해 인터넷에 연결할 수 있지만 인터넷에서 원치 않는 인바운드 연결을 수신할 수 없다.
    - 퍼블릭 서브넷에서 퍼블릭 NAT 게이트웨이를 생성하고 생성 시 탄력적 IP 주소를 NAT 게이트웨이와 연결해야 합니다.
    - 트래픽을 NAT 게이트웨이에서 VPC용 인터넷 게이트웨이로 라우팅하거나 퍼블릭 NAT 게이트웨이를 사용하여 다른 VPC 또는 온프레미스 네트워크에 연결 가능. 이 경우 NAT 게이트웨이에서 Transit Gateway 또는 가상 프라이빗 게이트웨이를 통해 트래픽을 라우팅.
2. 프라이빗
    - 프라이빗 서브넷의 인스턴스는 프라이빗 NAT 게이트웨이를 통해 다른 VPC 또는 온프레미스 네트워크에 연결할 수 있다.
    - 트래픽을 NAT 게이트웨이에서 Transit Gateway 또는 가상 프라이빗 게이트웨이를 통해 트래픽을 라우팅할 수 있다.
    - 동적 ip주소 할당은 불가.
    - 프라이빗 NAT 게이트웨이에서 인터넷 게이트웨이로 트래픽을 라우팅하는 경우 인터넷 게이트웨이가 트래픽을 삭제.

- 프라이빗 서브넷이 인터넷과 통신하기 위한 아웃바인드 인스턴스(동시에 인바운드도 막아줌)
- 외부에서 요청되는 인바운드가 없어도 펌웨어 및 업데이트 때문에 사용해야 할 때가 있음.
- 프라이빗 서브넷 내부 인스턴스를 대신해서 통신하는 것이기에 퍼블릭 서브넷에 있어야 함.
- 서브넷 단위
- 아웃바운드 트레픽을 받아 인터넷 게이트와 연결
- NAT 인스턴스보다 게이트웨이 서비스를 권장함. (더 나은 가용성과 대역폭)
- 각 가용 영역에서 만들 수 있는 NAT 게이트웨이 개수에는 할당량 존재.

<aside>
💡 transit gateway
VPC, VPN 연결 및 AWS Direct Connect 연결 간에 트래픽을 라우팅하는 중앙 허브 역할을 하는 transit gateway를 사용하여 VPC와 온프레미스 네트워크를 연결할 수 있다.

</aside>

## Bastion Host

- 외부에서 사설 네트워크에 접속할 수 있도록 경로를 확보해주는 서버.
- 해당 프라이빗 인스턴스에 접근하기 위한 EC2 인스턴스
- 퍼블릭 서브넷에 위치

## VCP 피어링
VPC 피어링 연결은 비공개적으로 두 VPC 간에 트래픽을 라우팅할 수 있도록 하기 위한 두 VPC 사이의 네트워킹 연결한다. 동일한 네트워크 내에 있는 것처럼 서로 통신할 수 있고, 인터넷은 통하지 않는다.

---

## DHCP 옵션셋
- 리전의 각 VPC는 다음과 같은 네트워크 구성을 포함하는 동일한 기본 DHCP 옵션 세트를 사용
    - 도메인 이름
    - 도메인 이름 서버
- Amazon DHCP 서버는 기본 옵션 세트에 저장된 네트워크 구성을 사용
- PC로 인스턴스를 시작하면 인스턴스는 DHCP 서버(1)와 상호 작용하고, Amazon DNS 서버(2)와 상호 작용하며, VPC의 라우터(3)를 통해 네트워크의 다른 디바이스에 연결

<aside>
💡 DHCP?
해당 IP(인터넷 프로토콜) 주소와 기타 관련 구성 정보(예: 서브넷 마스크 및 기본 게이트웨이)를 IP 호스트에 자동으로 제공하는 클라이언트/서버 프로토콜

</aside>

---

## 보안

## 보안그룹
보안 그룹(SG)은 연결된 리소스에 도달하고 나갈 수 있는 트래픽을 제어한다. VPC를 생성할 경우 VPC는 기본 보안 그룹과 함께 제공되며, 요금은 나가지 않는다.

- 보안그룹은 모든 허용을 차단하기 때문에 필요한 설정을 허용해야 함.
- 보안 그룹 별로 별도의 트래픽 설정할 수 있음
- 인스턴스 단위
- 보안 그룹은 상태가 저장된다. → 처음 인바운드 된 트래픽이 아웃바운드 규칙 없이 인스턴스를 떠날 수 있다.

## ACL
<aside>
💡 *네트워크 액세스 제어 목록(ACL)*은 서브넷 수준에서 특정 인바운드 또는 아웃바운드 트래픽을 허용하거나 거부합니다. VPC에 대한 기본 네트워크 ACL을 사용하거나 보안 그룹에 대한 규칙과 유사한 규칙을 사용하여 VPC에 대한 사용자 지정 네트워크 ACL을 생성하여 VPC에 보안 계층을 추가할 수 있습니다.

</aside>

- ACL은 모든 트래픽을 기본 설정, 불필요한 트래픽을 막도록 적용.
- 서브넷 단위
- 번호가 가장 낮은 규칙부터 적용
- 규칙은 100단위로 설정할 것을 권장.
- (*)규칙은 패킷이 번호가 매겨진 다른 어떤 규칙과도 일치하지 않을 경우에는 거부

| 인바운드 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| 규칙 # | Type | 프로토콜 | 포트 범위 | 소스 | 허용/거부 |
| 100 | 모든 IPv4 트래픽 | 모두 | 모두 | 0.0.0.0/0 | 허용 |
| * | 모든 IPv4 트래픽 | 모두 | 모두 | 0.0.0.0/0 | DENY |

| 아웃바운드 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| 규칙 # | Type | 프로토콜 | 포트 범위 | 대상 주소 | 허용/거부 |
| 100 | 모든 IPv4 트래픽 | 모두 | 모두 | 0.0.0.0/0 | 허용 |
| * | 모든 IPv4 트래픽 | 모두 | 모두 | 0.0.0.0/0 | DENY |
- 우선순위 : 보안그룹 > ACL
